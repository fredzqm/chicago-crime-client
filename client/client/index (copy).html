<!doctype html>
<!--
  Copyright 2016 Google Inc. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
      https://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="en">
<head>
  <title>Crime Reporting Client</title>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDn-KbNy_hUN9aYrYyoIivwJqktNDo2Euw&libraries=visualization"></script>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
  
  <script type="text/javascript">
  function initialize() {
        var mapOptions = {
            zoom: 13,
            center: new google.maps.LatLng(37.774546, -122.433523),
            mapTypeId: google.maps.MapTypeId.SATELLITE
        };

        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);

        pointArray = new google.maps.MVCArray(taxiData);

        heatmap = new google.maps.visualization.HeatmapLayer({
            data: pointArray
        });

        heatmap.setMap(map);
    }
  $(document.body).on("onload", initialize);
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/3.6.10/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBoF2gpK4ISX5Tpov0EFqEI2NhJLFu1JWQ",
      authDomain: "chicago-crime-c82fb.firebaseapp.com",
      databaseURL: "https://chicago-crime-c82fb.firebaseio.com",
      storageBucket: "chicago-crime-c82fb.appspot.com",
      messagingSenderId: "766373141579"
    };
    firebase.initializeApp(config);
  </script>
</head>
<body>
<div>NumRunners: <input type="text" id="num-runners" value="2" /></div>
<input type="file" id="file-input" />
<div id="map_canvas" style="height: 600px; width: 800px;"></div>

<!-- <script src="scripts/main.js"></script> -->
<script type="text/javascript">
  listeningFirebaseRefs = [];
  currCrimes = {};
  currCrimesKeys = [];

// AIzaSyDHyiI31YHTNIylA6_otrWZWiN5tZiK7QA
  var HttpClient = function() {
      this.get = function(aUrl, aCallback) {
          var anHttpRequest = new XMLHttpRequest();
          anHttpRequest.onreadystatechange = function() { 
              if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                  aCallback(anHttpRequest.responseText);
          }

          anHttpRequest.open( "GET", aUrl, true );            
          anHttpRequest.send( null );
      }
  }

  function startDatabaseQueries() {
    var crimesRef = firebase.database().ref('crimes').limitToLast(100);

    var fetchPosts = function(crimesRef) {
      crimesRef.on('child_added', function(data) {
        if (currCrimesKeys.length > 100) {
          delete currCrimes[currCrimesKeys.shift()];
        }

        currCrimes[data.key] = data.val();
        currCrimesKeys.push(data.key);

        var address = data.val().location.replace("XX", "00");
        address += ", CHICAGO, IL";
        console.log(address);
        var client = new HttpClient();
        client.get('https://maps.googleapis.com/maps/api/geocode/json?address=' + address + "&key=AIzaSyDHyiI31YHTNIylA6_otrWZWiN5tZiK7QA", function(response) {
            responseObj = JSON.parse(response);
            currCrimes[data.key].lat = responseObj.results[0].geometry.location.lat;
            currCrimes[data.key].lng = responseObj.results[0].geometry.location.lng;
            currCrimes[data.key].weight = 1;
        });

        console.log("Added; " + currCrimes);
      });
      crimesRef.on('child_changed', function(data) { 
        currCrimes[data.key] = data.val();

        console.log("Changed; " + currCrimes);
      });
      crimesRef.on('child_removed', function(data) {
        delete currCrimes[data.key];

        for(var i = 0; i < currCrimesKeys.length; i++){
          if (currCrimesKeys[i] == data.key){
            currCrimesKeys.splice(i, 1);
          }
        }

        console.log("Removed; " + currCrimes);
      });
    };

    // Fetching and displaying all posts of each sections.
    fetchPosts(crimesRef);

    // Keep track of all Firebase refs we are listening to.
    listeningFirebaseRefs.push(crimesRef);
  }

  startDatabaseQueries();

  // document.addEventListener("DOMContentLoaded", function(event) {
  //   // initMap();
  // // don't forget to add gmaps-heatmap.js
  // var myLatlng = new google.maps.LatLng(25.6586, -80.3568);
  // // map options,
  // var myOptions = {
  //   zoom: 3,
  //   center: myLatlng
  // };
  // // standard map
  // map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
  // // heatmap layer
  // heatmap = new HeatmapOverlay(map, 
  //   {
  //     // radius should be small ONLY if scaleRadius is true (or small radius is intended)
  //     "radius": 2,
  //     "maxOpacity": 1, 
  //     // scales the radius based on map zoom
  //     "scaleRadius": true, 
  //     // if set to false the heatmap uses the global maximum for colorization
  //     // if activated: uses the data maximum within the current map boundaries 
  //     //   (there will always be a red spot with useLocalExtremas true)
  //     "useLocalExtrema": true,
  //     // which field name in your data represents the latitude - default "lat"
  //     latField: 'lat',
  //     // which field name in your data represents the longitude - default "lng"
  //     lngField: 'lng',
  //     // which field name in your data represents the data value - default "value"
  //     valueField: 'count'
  //   }
  // );

  // var testData = {
  //   max: 8,
  //   data: [{lat: 24.6408, lng:46.7728, count: 3},{lat: 50.75, lng:-1.55, count: 1}]
  // };

  // heatmap.setData(testData);
  // });

</script>
</body>
</html>
