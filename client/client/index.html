
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps JavaScript API v3 Example: Heatmap Layer</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
    <link href="https://developers.google.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
    
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization&key=AIzaSyDn-KbNy_hUN9aYrYyoIivwJqktNDo2Euw"></script>
    <script>
      // Adding 500 Data Points

    // Adding 500 Data Points
    var map, pointarray, heatmap; 

    taxiData = [
    ];

    function initialize() {
        var mapOptions = {
            zoom: 10,
            center: new google.maps.LatLng(41.8057495,-87.8705634),
            mapTypeId: google.maps.MapTypeId.SATELLITE
        };

        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);

        pointArray = new google.maps.MVCArray(taxiData);

        heatmap = new google.maps.visualization.HeatmapLayer({
            data: pointArray
        });

        heatmap.setMap(map);
    }

    function toggleHeatmap() {
        heatmap.setMap(map);
    }

    function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.setOptions({
            gradient: heatmap.get('gradient') ? null : gradient
        });
    } 
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/3.6.10/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBoF2gpK4ISX5Tpov0EFqEI2NhJLFu1JWQ",
        authDomain: "chicago-crime-c82fb.firebaseapp.com",
        databaseURL: "https://chicago-crime-c82fb.firebaseio.com",
        storageBucket: "chicago-crime-c82fb.appspot.com",
        messagingSenderId: "766373141579"
      };
      firebase.initializeApp(config);
    </script>
  </head>

  <body onload="initialize()">
    <div id="map_canvas" style="height: 600px; width: 800px;"></div>

    <script type="text/javascript">
      listeningFirebaseRefs = [];
      currCrimes = {};
      currCrimesKeys = [];

    // AIzaSyDHyiI31YHTNIylA6_otrWZWiN5tZiK7QA
      var HttpClient = function() {
          this.get = function(aUrl, aCallback) {
              var anHttpRequest = new XMLHttpRequest();
              anHttpRequest.onreadystatechange = function() { 
                  if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                      aCallback(anHttpRequest.responseText);
              }

              anHttpRequest.open( "GET", aUrl, true );            
              anHttpRequest.send( null );
          }
      }

      function startDatabaseQueries() {
        var crimesRef = firebase.database().ref('crimes').limitToLast(100);

        var fetchPosts = function(crimesRef) {
          crimesRef.on('child_added', function(data) {
            if (currCrimesKeys.length > 25) {
              delete currCrimes[currCrimesKeys.shift()];
              taxiData.shift();
            }

            currCrimes[data.key] = data.val();
            currCrimesKeys.push(data.key);

            var address = data.val().location.replace("XX", "00");
            address += ", CHICAGO, IL";
            console.log(address);
            var client = new HttpClient();
            client.get('https://maps.googleapis.com/maps/api/geocode/json?address=' + address + "&key=AIzaSyDHyiI31YHTNIylA6_otrWZWiN5tZiK7QA", function(response) {
                responseObj = JSON.parse(response);
                currCrimes[data.key].lat = responseObj.results[0].geometry.location.lat;
                currCrimes[data.key].lng = responseObj.results[0].geometry.location.lng;
                currCrimes[data.key].weight = 1;

                taxiData.push(new google.maps.LatLng(responseObj.results[0].geometry.location.lat, responseObj.results[0].geometry.location.lng));
                heatmap.setMap(map);
            });


            console.log("Added; " + currCrimes);

          });
          crimesRef.on('child_changed', function(data) { 
            currCrimes[data.key] = data.val();

            console.log("Changed; " + currCrimes);
          });
          crimesRef.on('child_removed', function(data) {
            delete currCrimes[data.key];

            for(var i = 0; i < currCrimesKeys.length; i++){
              if (currCrimesKeys[i] == data.key){
                currCrimesKeys.splice(i, 1);
              }
            }

            console.log("Removed; " + currCrimes);
          });
        };

        // Fetching and displaying all posts of each sections.
        fetchPosts(crimesRef);

        // Keep track of all Firebase refs we are listening to.
        listeningFirebaseRefs.push(crimesRef);
      }

      startDatabaseQueries();

      // document.addEventListener("DOMContentLoaded", function(event) {
      //   // initMap();
      // // don't forget to add gmaps-heatmap.js
      // var myLatlng = new google.maps.LatLng(25.6586, -80.3568);
      // // map options,
      // var myOptions = {
      //   zoom: 3,
      //   center: myLatlng
      // };
      // // standard map
      // map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
      // // heatmap layer
      // heatmap = new HeatmapOverlay(map, 
      //   {
      //     // radius should be small ONLY if scaleRadius is true (or small radius is intended)
      //     "radius": 2,
      //     "maxOpacity": 1, 
      //     // scales the radius based on map zoom
      //     "scaleRadius": true, 
      //     // if set to false the heatmap uses the global maximum for colorization
      //     // if activated: uses the data maximum within the current map boundaries 
      //     //   (there will always be a red spot with useLocalExtremas true)
      //     "useLocalExtrema": true,
      //     // which field name in your data represents the latitude - default "lat"
      //     latField: 'lat',
      //     // which field name in your data represents the longitude - default "lng"
      //     lngField: 'lng',
      //     // which field name in your data represents the data value - default "value"
      //     valueField: 'count'
      //   }
      // );

      // var testData = {
      //   max: 8,
      //   data: [{lat: 24.6408, lng:46.7728, count: 3},{lat: 50.75, lng:-1.55, count: 1}]
      // };

      // heatmap.setData(testData);
      // });

    </script>
  </body>
</html>
